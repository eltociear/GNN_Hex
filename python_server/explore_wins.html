<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="../styles/explore_results.css">
    <!--Insert link to stylesheet here-->
    <meta charset="utf-8"/>
</head>

<body>
<!--Insert board here-->
<div id="main-wrap">
    <div class="analyse__tools">
        <section class="explorer-box sub-box">
            <div class="data">
                <table class="moves">
                    <thead>
                        <tr>
                            <th class="title">Move</th>
                            <th class="title">Evaluation</th>
                        </tr>
                    </thead>
                    <tbody id="table_data">
                    </tbody>
                </table>
            </div>
        </section>
    </div>
    <div class="jumps">
        <button class="w3-button w3-large w3-black disabled" id="go_start" onclick="go_start()">&laquo;</button>
        <button class="w3-button w3-large w3-black disabled" id="go_back" onclick="go_back()">‹</button>
        <button class="w3-button w3-large w3-black disabled" id="go_forward" onclick="go_forward()">›</button>
        <button class="w3-button w3-large w3-black disabled" id="go_end" onclick="go_end()">&raquo;</button>
    </div>
</div>
<!--Insert path to gamescript here-->
<script>

function set_disablility(){
    document.getElementById("go_start").classList.remove("disabled")
    document.getElementById("go_back").classList.remove("disabled")
    document.getElementById("go_forward").classList.remove("disabled")
    document.getElementById("go_end").classList.remove("disabled")
    if (hist_index==position_hist.length-1){
        document.getElementById("go_forward").classList.add("disabled")
        document.getElementById("go_end").classList.add("disabled")
    }
    if (hist_index==0){
        document.getElementById("go_start").classList.add("disabled")
        document.getElementById("go_back").classList.add("disabled")
    }
}

function xml_http_post(url, data, callback) {
    req = new XMLHttpRequest();
    req.open("POST", url, true);
    req.onreadystatechange = function() {
        if (this.readyState == 4) {
            callback(JSON.parse(this.responseText));
        }
    }
    req.send(JSON.stringify(data));
}

function show_moves(){
    function mappo(move){
        var testpos = position.slice();
        testpos[move] = onturn;
        return [move,evaluate(testpos)];
    }
    document.getElementById("table_data").innerHTML="";
    function have_moves_to_show(server_data){
        console.log(server_data)
        var miteval = [];
        curval = server_data.moves[0][1]
        miteval = server_data.moves.slice(1)
        for (var i=0;i<miteval.length;i++){
            var move = miteval[i][0];
            var evaluation = miteval[i][1];
            var evalconvert = {"u":"Unknown",0:"Draw",1:"Black wins","-1":"White wins"}
            var tr = document.createElement("tr");
            var move_elem = document.createElement("td");
            var eval_elem = document.createElement("td");
            move_elem.innerText = move_int_to_str(move);
            eval_elem.innerText = evalconvert[evaluation];
            tr.appendChild(move_elem);
            tr.appendChild(eval_elem);
            tr.setAttribute("onclick","real_move("+move+")")
            document.getElementById("table_data").appendChild(tr);
        }
    }
    my_data = {"position":position,"onturn":onturn-1}
    xml_http_post("python_server/explore_wins.html",my_data,have_moves_to_show)
}

function getmoves(position){
    moves = []
    for (x=0;x<position.length;x++){
        if (position[x]==0){
            moves.push(x)
        }
    }
    return moves
}

function real_move(move){
    position[move]=onturn;
    onturn = onturn==1?2:1;
    hist_index++;
    position_hist = position_hist.slice(0,hist_index)
    position_hist.push(position.slice(0))
    show_pos();
    show_moves();
    set_disablility();
}

function player_move(move){
    if (position[move]==0){
        real_move(move)
    }
}

function reset(){
    position = new Array(num_squares).fill(0);
    onturn = 2;
    var tds = get_squares()
    for (var i=0;i<tds.length;i++){
        tds[i].setAttribute("onclick", "player_move("+i+")");
    }
}

function show_pos(){
    squares = get_squares();
    for (i=0;i<squares.length;i++){
        td = squares[i];
        if (position[i] == 0){
            td.innerHTML = ""
        }
        else if (position[i] == 1){
            td.innerHTML="<div class='stone whitestone'></div>"
        }
        else if (position[i] == 2){
            td.innerHTML="<div class='stone blackstone'></div>"
        }
    }
}

function move_forward(){
    if (hist_index==position_hist.length-1){return}
    hist_index++;
    position = position_hist[hist_index].slice()
    onturn = onturn==1?2:1;
}

function go_forward(){
    move_forward();
    show_moves();
    set_disablility();
    show_pos();
}

function go_end(){
    while (hist_index!=tree_move.length-1){
        move_forward();
    }
    show_moves();
    set_disablility();
    show_pos();
}

function move_back(){
    if (hist_index==0){return}
    hist_index--;
    onturn = onturn==1?2:1;
    position = position_hist[hist_index].slice()
}

function go_back(){
    move_back();
    show_moves();
    set_disablility();
    show_pos();
}

function go_start(){
    while (hist_index!=0){
        move_back()
    }
    show_moves();
    set_disablility();
    show_pos();
}

position = new Array(num_squares).fill(0);
position_hist = [position]
hist_index = 0
onturn = 2;
reset();
show_moves();
</script>
</body>
</html>